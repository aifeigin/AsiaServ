<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedback Form</title>
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/contact.css">

    <link href='https://fonts.googleapis.com/css?family=Open Sans' rel='stylesheet'>

    <style>
    </style>
</head>

<body>
    <header>
        <div class="menu-container">
            <div class="block left">
                <img src="/images/logo_as.svg" alt="logo" class="logo">
            </div>
            <div class="block right">
                <nav class="horizontal-menu">
                    <ul>
                        <li><a href="/index.html">QA</a></li>
                        <li><a href="constellations.html">IT Constellations</a></li>
                        <li><a href="blog.html">Blog</a></li>
                        <li><img src="/images/map-icons.svg" alt="lang"></li>
                    </ul>
                </nav>
            </div>
        </div>
        <div class="outer_container wrapper">
            <div class="inner-container-contact left">
                <h1>Let's connect</h1>
                <img src="/images/my_photo.png" width="226" height="230" alt="Avatar picture" class="photo"/>
                <div>
                    Привет, меня зовут Ася, я специалист по контролю качества, бизнес-консультант и бизнес-расстановщик из Мадейры, Португалия. Имея более чем 20-летний опыт в обеспечении качества и консультировании клиентов, я работаю частным предпринимателем, помогая компаниям повышать качество программного обеспечения и решать сложные задачи.
Я здесь, чтобы помогать как контролем качества, так и бизнес-расстановками.
                </div>
                <div class="icon-text">
                    <img src="/images/icon phone.svg" alt="Icon" class="icon" />
                    <span class="text">+351913466398</span>
                </div>
                <div class="icon-text">
                    <img src="/images/icon whatsap.svg" alt="Icon" class="icon" />
                    <span class="text">+380503874698 (WhatsApp, Telegram, Viber)</span>
                </div>
                <div class="icon-text">
                    <img src="/images/icon email.svg" alt="Icon" class="icon" />
                    <span class="text">asya.rupcheva@gmail.com</span>
                </div>
            </div>
            <div class="inner-container-contact right">
                <h3>Ready to Begin? Share Your Info Below</h3>
                <form id="feedbackForm" class="form">
                    <input type="text" id="name" name="name" placeholder="Имя" required class="form-field">
                    <input type="email" id="email" name="email" placeholder="E-mail" required class="form-field">
                    <input type="tel" id="phone" name="phone" placeholder="Номер телефона (опционально)" class="form-field">
                    <textarea id="message" name="message" placeholder="Сообщение" required rows="3" class="form-field"></textarea>
                    
                    <!-- CAPTCHA Widget -->
                    <div class="form-actions">
                         <div class="g-recaptcha" data-sitekey="6Ldy53EqAAAAACf3FsYjUzn0vQaqaDfIpjzWPx-D"></div> <!-- Replace with your CAPTCHA site key -->
                         <div class="small_text">
                            Отправляя данную форму, Вы даете согласие на сбор и обработку ваших персональных данных на условиях нашей публичной оферты в целях рассмотрения вашего запроса и предоставления сопутствующих услуг.
                         </div>
                         <button id="submit" name="submit" type="submit" class="rounded-button left">Send</button>
                    </div>
                </form>
            </div>
        </div>
        <div class="black-container">
            <div class="left logo">
                <img src="/images/logo_as_w.svg" alt="logo">
                <div class="text w">&copy; 2024 Asia Rupcheva, Funchal.<br />All rights reserved.</div>
            </div>
            <div class="block center">
                <img src="/images/phone.svg" alt="phone" class="center-image">
            </div>
            <div class="block right">
                <nav class="menu_down">
                    <ul>
                        <li><a href="constellations.html">IT Constellations</a></li>
                        <li><a href="blog.html">Blog</a></li>
                        <li><a href="/index.html">QA</a></li>
                    </ul>
                </nav>
            </div>
        </div>

    </header>

    <script>
        document.addEventListener("DOMContentLoaded", async function () {
            const form = document.getElementById("feedbackForm");

            // Get CSRF token
            let csrfToken;
            try {
                const csrfResponse = await fetch(`${window.location.origin}/api/get-csrf-token`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    },
                });

                if (!csrfResponse.ok) {
                    throw new Error('Failed to fetch CSRF token');
                }

                const csrfData = await csrfResponse.json();
                csrfToken = csrfData.token;
            } catch (error) {
                console.error("Error fetching CSRF token:", error);
                return;
            }

            form.addEventListener("submit", async (event) => {
                event.preventDefault();

                const feedbackData = {
                    name: document.getElementById("name").value,
                    email: document.getElementById("email").value,
                    phone: document.getElementById("phone").value,
                    message: document.getElementById("message").value
                };

                // Get CAPTCHA token
                const captchaToken = grecaptcha.getResponse();
                if (!captchaToken) {
                    alert("Please complete the CAPTCHA.");
                    return;
                }

                try {
                    let buttonID = document.getElementById("submit");

                    let buttonText = replaceButtonText(buttonID, "Wait<span class='dot'></span>");

                    const response = await fetch(`${window.location.origin}/api/feedback`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRF-TOKEN": csrfToken,
                            "X-Captcha-Token": captchaToken
                        },
                        body: JSON.stringify(feedbackData)
                    });

                    replaceButtonText(buttonID, buttonText);

                    if (response.ok) {
                        alert("Feedback sent successfully!");
                        grecaptcha.reset(); // Reset the CAPTCHA after successful submission
                    } else {
                        alert("Error sending feedback." + response.statusText);
                    }
                } catch (error) {
                    console.error("Error:", error);
                    alert("Error sending feedback." + error);
                }
            });
        });

        function replaceButtonText(button, text) {
            if (button && text) {
                let oldText = null;
                if (button.innerHTML) {
                    oldText = button.innerHTML;
                    button.innerHTML = text;
                }
                else if (button.childNodes[0]) {
                    oldText = button.childNodes[0].nodeValue;
                    button.childNodes[0].nodeValue = text;
                }
                else if (button.value) {
                    oldText = button.value;
                    button.value = text;
                }

                return oldText;
            }

            return null;
        }

    </script>

</body>
</html>